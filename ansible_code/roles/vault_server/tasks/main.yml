---
# ------------------------------------------------------------------------------
# 1. NETWORK & DEPENDENCIES
# ------------------------------------------------------------------------------
- name: Install and Authenticate Tailscale
  include_role:
    name: tailscale

- name: Install Vault Prerequisites
  block:
    - name: Download HashiCorp GPG key (ASCII)
      ansible.builtin.get_url:
        url: "https://apt.releases.hashicorp.com/gpg"
        dest: "/usr/share/keyrings/hashicorp-archive-keyring.asc" # Use .asc for text keys
        mode: '0644'

    - name: Add HashiCorp Repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/hashicorp-archive-keyring.asc] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
        filename: hashicorp
        state: present
        update_cache: true

    - name: Install Vault
      ansible.builtin.apt:
        name: vault
        state: present

# ------------------------------------------------------------------------------
# 2. CONFIGURATION & FILESYSTEM
# ------------------------------------------------------------------------------
- name: Configure Vault System
  block:
    - name: Ensure Vault directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: '0750'
      loop:
        - "{{ vault_paths.data }}"
        - "{{ vault_paths.tls }}"
        - "{{ vault_paths.config }}"

    - name: Generate Tailscale TLS Certs for Vault
      ansible.builtin.command: >
        tailscale cert 
        --cert-file={{ vault_paths.tls }}/{{ vault_fqdn }}.crt 
        --key-file={{ vault_paths.tls }}/{{ vault_fqdn }}.key 
        {{ vault_fqdn }}
      args:
        creates: "{{ vault_paths.tls }}/{{ vault_fqdn }}.crt"
      # Notify restart so Vault picks up new certs if they change
      notify: Restart Vault

    - name: Fix Certificate Permissions
      ansible.builtin.file:
        path: "{{ vault_paths.tls }}/{{ vault_fqdn }}.{{ item }}"
        owner: "{{ vault_user }}"
        group: "{{ vault_group }}"
        mode: '0640'
      loop:
        - crt
        - key

    - name: Remove default config file
      ansible.builtin.file:
        path: /etc/vault.d/vault.hcl
        state: absent

    - name: Deploy Vault Configuration
      ansible.builtin.template:
        src: vault-config.json.j2
        dest: "/etc/vault.d/vault.hcl"
        owner: vault
        group: vault
        mode: '0640'
      notify: Restart Vault

# ------------------------------------------------------------------------------
# 3. ENVIRONMENT & SERVICE
# ------------------------------------------------------------------------------
- name: Finalize Setup
  block:
    - name: Set Vault environment variables (Profile)
      ansible.builtin.copy:
        dest: /etc/profile.d/vault.sh
        content: |
          export VAULT_ADDR='https://127.0.0.1:8200'
          export VAULT_SKIP_VERIFY=true
        mode: '0644'

    - name: Enable and Start Vault Service
      ansible.builtin.systemd:
        name: vault
        state: started
        enabled: true
        daemon_reload: true