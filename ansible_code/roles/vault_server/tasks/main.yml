---
# 1. Download and Dearmor Key
- name: Download HashiCorp GPG key
  ansible.builtin.get_url:
    url: "https://apt.releases.hashicorp.com/gpg"
    dest: "/usr/share/keyrings/hashicorp-archive-keyring.gpg"
    mode: '0644'
    decompress: true # This sometimes helps, but usually get_url just grabs raw bytes

# 2. Check if key is ASCII
- name: Check key format
  ansible.builtin.command: head -n 1 /usr/share/keyrings/hashicorp-archive-keyring.gpg
  register: key_head
  changed_when: false

# 3. Convert to Binary ONLY if it is ASCII
- name: Convert key to binary if needed
  ansible.builtin.shell: |
    mv /usr/share/keyrings/hashicorp-archive-keyring.gpg /tmp/hashicorp.asc
    gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg /tmp/hashicorp.asc
    rm /tmp/hashicorp.asc
  when: "'BEGIN PGP' in key_head.stdout"

# 4. Add Repository
- name: Add HashiCorp Repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
    filename: hashicorp
    state: present
    update_cache: true

# 5. Install Vault Binary
- name: Install Vault
  ansible.builtin.apt:
    name: vault
    state: present
    update_cache: true

# 6. Remove Default Config File
- name: Remove default config file
  ansible.builtin.file:
    path: /etc/vault.d/vault.hcl
    state: absent

# 7. Create Directories with Correct Permissions
- name: Ensure Vault directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: '0750'
  loop:
    - "{{ vault_paths.data }}"
    - "{{ vault_paths.tls }}"
    - "{{ vault_paths.config }}"

# 8. Copy Tailscale Certs to Vault Directory
- name: Copy Certificates to Vault TLS dir
  ansible.builtin.copy:
    src: "/opt/vault/tls/{{ vault_fqdn }}.{{ item }}" # Assuming original location
    dest: "{{ vault_paths.tls }}/{{ vault_fqdn }}.{{ item }}"
    remote_src: true
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: '0640'
  loop:
    - crt
    - key
  notify: Restart Vault

# 9. Configure Vault (Write JSON content to .hcl file)
- name: Configure Vault
  ansible.builtin.template:
    src: vault-config.json.j2
    dest: "/etc/vault.d/vault.hcl"
    owner: vault
    group: vault
    mode: '0640'
  notify: Restart Vault

# 10. Set VAULT_ADDR globally for all users
- name: Add Vault environment variables
  ansible.builtin.copy:
    dest: /etc/profile.d/vault.sh
    content: |
      export VAULT_ADDR='https://127.0.0.1:8200'
      export VAULT_SKIP_VERIFY=true
    mode: '0644'

# 11. Ensure Service is Running
- name: Enable and Start Vault Service
  ansible.builtin.systemd:
    name: vault
    state: started
    enabled: true
    daemon_reload: true